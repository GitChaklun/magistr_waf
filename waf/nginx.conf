# waf/nginx.conf
worker_processes  1;

events { worker_connections 1024; }

http {
    include       mime.types;
    default_type  application/octet-stream;
    sendfile      on;
    keepalive_timeout  65;

    # Логи (мапляться на ./waf/logs)
    access_log  /var/log/waf_results/access.log;
    error_log   /var/log/waf_results/error.log notice;

    # Upstream — назва сервісу з docker-compose (мережа magistr_waf_net)
    upstream juice_upstream {
        server juice:3000;
        keepalive 16;
    }

    server {
        listen 80 default_server;
        server_name _;

        # Простий healthcheck без проксі — для швидкої діагностики
        location = /health {
            return 200 'ok';
        }

        # Мінімальний "WAF" прямо тут (без зовнішнього файлу)
        access_by_lua_block {
            local function as_string(v)
              if type(v) == "table" then return table.concat(v, " ")
              elseif v == nil then return "" else return tostring(v) end
            end
            local args = ngx.req.get_uri_args()
            local patterns = {
              "<script", "onload=", "../", "etc/passwd",
              " or 1=1", "; cat /etc/passwd", "`whoami`", "| id", "; id"
            }
            for k,v in pairs(args) do
              local s = string.lower(as_string(v))
              for _,p in ipairs(patterns) do
                if string.find(s, p, 1, true) then
                  ngx.log(ngx.NOTICE, "blocked by simple waf: ", k, "=", s)
                  return ngx.exit(403)
                end
              end
            end
            -- інакше пропускаємо далі
        }

        location / {
            proxy_http_version 1.1;
            proxy_set_header Connection "";
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;

            proxy_connect_timeout 2s;
            proxy_read_timeout    30s;
            proxy_send_timeout    30s;

            proxy_pass http://juice_upstream;
        }
    }
}
