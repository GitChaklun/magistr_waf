worker_processes 1;
error_log /var/log/waf_results/error.log info;

events { worker_connections 1024; }

http {
    lua_package_path "/usr/local/openresty/lualib/?.lua;;";

    # access log — зручний для збирання CSV
    log_format waffmt '$time_iso8601,$remote_addr,$request_method,$request_uri,$status,$request_time';
    access_log /var/log/waf_results/access.log waffmt;

    server {
        listen 80;

        # Проста точка для lua-waf hook в access_by_lua_block
        access_by_lua_block {
            local ok, waf = pcall(require, "waf")
            if not ok or not waf then
                ngx.log(ngx.ERR, "WAF module not found or failed to load; allowing request. require error: ", waf)
            else
                -- викликаємо waf.run() в безпечному pcall
                local succ, res = pcall(function() return waf.run() end)
                if not succ then
                    ngx.log(ngx.ERR, "WAF run() failed; allowing request. err: ", res)
                else
                    -- очікуємо, що waf.run() повертає true (ok) або false (blocked)
                    if res == false or res == "block" then
                        ngx.status = ngx.HTTP_FORBIDDEN
                        ngx.say("Blocked by WAF")
                        return ngx.exit(ngx.HTTP_FORBIDDEN)
                    end
                end
            end
            -- якщо немає модуля або помилка — запит пропускаємо
        }

        location / {
            proxy_pass http://juice:3000;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        }
    }
}

